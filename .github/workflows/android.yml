name: Android

on:
  pull_request:
  push:
  release:
    types: [published]

jobs:
  build:
    name: Android
    runs-on: macos-latest

    env:
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      APP_BUNDLE_ID: 'codes.redth.myamazingapp'
      APP_PROJECT: './MyAmazingApp/MyAmazingApp.csproj'

    steps:
    - name: 'ğŸ›’ Checkout'
      uses: actions/checkout@v2

    #- name: 'ğŸª„ Install .NET'
    #  uses: actions/setup-dotnet@v3
    #  with:
    #    dotnet-version: 7.0.x

    - name: 'ğŸª„ Install: .NET Workloads'
      run: dotnet workload install maui android

    - name: 'âš’ï¸ Build: Android'
      shell: pwsh
      run: |
        [IO.File]::WriteAllBytes("$env:GITHUB_WORKSPACE/MyAmazingApp/app.keystore",	([convert]::FromBase64String("${{ secrets.ANDROID_KEYSTORE }}")) )  

        dotnet publish `
          -f net7.0-android `
          -p:Configuration=Release `
          -p:AndroidKeyStore=True `
          -p:AndroidSigningKeyStore=app.keystore `
          -p:AndroidSigningKeyAlias=key `
          -p:AndroidSigningKeyPass='${{ secrets.ANDROID_KEYSTORE_PASS }}' `
          -p:AndroidSigningStorePass='${{ secrets.ANDROID_KEYSTORE_PASS }}' `
          -bl:android.binlog `
          ${{ env.APP_PROJECT }}

    - name: 'ğŸªµ Artifacts: .apk'
      uses: actions/upload-artifact@v3
      with:
        name: App.apk
        path: ./**/*.apk

    - name: 'ğŸªµ Artifacts: .aab'
      uses: actions/upload-artifact@v3
      with:
        name: App.aab
        path: ./**/*.aab

    - name: 'ğŸªµ Artifacts: .binlog'
      uses: actions/upload-artifact@v3
      with:
        name: Binlogs
        path: ./**/*.binlog
